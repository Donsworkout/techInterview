[목록으로](https://github.com/Donsworkout/techInterview/blob/master/README.md)

## 무중단 배포 
https://perfectacle.github.io/2019/04/21/non-stop-deployment/

### 개요 
먼저 우리가 일반적으로 생각하는 배포는 아래와 같다.

1. 새롭게 배포할 내용이 있으니, 포트 충돌 방지를 위하여 기존 운영되는 서버를 다운시킨다.
2. **[공사중]** 배너를 건다
3. 새롭게 배포될 서버를 띄운다.

개인 홈페이지 정도는 괜찮지만 핵심 서비스에 배포 때문에 새로운 서버를 띄우는데 오랜 시간이 걸린다면, 심각한 손실이 발생할 수 있다. (예를 들어 결제)  
이를 방지하기 위해 무중단 배포가 필요하다.

### 무중단 배포의 조건 
- 두대 이상의 서버로 서비스해야 한다. (하나를 내리면 하나는 살아있어야 하기 때문)
- 비용을 위해 배포시에만 두개의 서버를 운용해도 된다.

### 무중단 배포의 종류
### Rolling Deployment
![elb-basic](https://user-images.githubusercontent.com/26560119/63570930-9de28300-c5b9-11e9-9d17-3a29d374c455.png)
- 로드밸런서도 두개를 운용하는게 좋음 

1. 배포할 서버 한대 (서버1) 를 로드밸런서에서 제외시킨다.
2. 제외된 서버1 에 배포한다.
3. 서버1의 배포가 끝나면, 다시 로드밸런서에 넣는다.
4. 배포가 아직 되지 않은 서버2를 로드밸런서에서 제외시킨다.
5. 제외된 서버2 에 배포한다.
6. 서버2의 배포가 끝나면, 다시 로드밸런서에 넣는다.

단점은 배포 시간이 오래걸리고,  
누구는 이전 버전을 서비스 받고 누구는 다음 버전을 서비스받는 문제가 생긴다.

### Blue / Green Deployment
![thumbs](https://user-images.githubusercontent.com/26560119/63571233-98d20380-c5ba-11e9-8142-76f762ce3feb.jpg)

> Blue 는 실제 프로덕션 환경을 말하고, Green 은 새롭게 배포할 환경(alpha) 이다.  
이 둘을 항상 띄워놓고 배포할때 사용하는것을 말한다.

### 장점
1. 새롭게 배포할 환경에만 배포하면 되기 때문에 속도가 빠르다.

2. 언제나 Green 환경도 준비되어 있으므로 만약에 잘못된 버전으로 배포했을 경우에 빠른 롤백이 가능하다.

3. 언제나 Green 환경이 준비되어있어야 하므로 비용도 두 배로 든다.

### 순서

1. 우선 기존의 서버그룹과 같은 서버그룹을 하나 더 만든다. 서버 버전도 동일하고 모든게 똑같지만 로드밸런서에 연결되어 있지는 않다.

    ![블루그린_여러그룹_1](https://user-images.githubusercontent.com/26560119/63576805-eef97380-c5c7-11e9-8287-02592a011485.png)

2. 복사한 서버그룹 내부의 서버들을 1.0.2버전으로 업데이트 진행한다. 여전히 로드밸런서에는 연결되어 있지 않다.

    ![블루그린_여러그룹_2](https://user-images.githubusercontent.com/26560119/63576807-ef920a00-c5c7-11e9-9767-200c819aea60.png)

3. 업데이트가 진행된 복사한 서버그룹을 로드밸런서에 연결한다.

    ![블루그린_여러그룹_3](https://user-images.githubusercontent.com/26560119/63576808-ef920a00-c5c7-11e9-829c-c55dc1a67463.png)

4. 기존에 존재하던 1.0.1버전 서버그룹을 로드밸런서에서 연결 해제한다. 이 상태부터 사용자들은 온전하게 1.0.2버전을 이용할 수 있게 된다.

    ![블루그린_여러그룹_4](https://user-images.githubusercontent.com/26560119/63577134-b4dca180-c5c8-11e9-86a9-1f0279483df3.png)


- 업데이트를 진행하는 도중에도 서버의 수는 그대로 유지되기 때문에 기존 사용되던 그대로 서버를 업데이트 하면 된다. 따라서 부하가 걸릴 위험이 사라진다.

- 만약 1.0.2버전에 문제가 있으면 아직 없애지 않은 1.0.1 버전의 서버그룹으로 로드밸런서를 연결해 주기만 하면 된다. 이후에 1.0.2 버전의 문제를 해결하고 다시 로드밸런서만 옮겨서 연결하면 된다.

### 회고
그러나 이같은 경우는 클라우드 환경이나 서버를 융통성있게 운용하는 환경에서나 가능하다. 물리 서버를 설치해놓고 평소에 그린환경의 서버그룹을 쓰지 않는다면 자원이 아깝다. (테스트서버를 그린환경으로 해놓고 쓰는 등의 효율적 운용이 필요)